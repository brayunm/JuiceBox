var H=Object.defineProperty;var P=(s,e,t)=>e in s?H(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var l=(s,e,t)=>P(s,typeof e!="symbol"?e+"":e,t);const T=s=>{let e=null;return{getInstance(){return e??(e=new s)}}};class I{constructor(){l(this,"observables",new Map);l(this,"callbacks",new Map)}createObservable(e,t){return this.observables.set(e,t),this.callbacks.set(e,[]),{subscribe:r=>{(this.callbacks.get(e)||[]).push(r),r(t)},next:r=>{this.observables.set(e,r),(this.callbacks.get(e)||[]).forEach(o=>o(r))},getValue:()=>this.observables.get(e)}}destroy(){this.callbacks.clear(),this.observables.clear()}}const re={FAST:"fast"},E={HOME:"home",WORK:"work",OTHER:"other"},b="Ambachtenstraat 33, Izegem, 8870, BEL",v=()=>typeof chrome<"u"&&chrome!==null&&!!chrome.storage;class K extends I{constructor(){super();l(this,"settings$",this.createObservable("settings",{workAddress:b}));this._loadSettingsFromStorage()}async _loadSettingsFromStorage(){try{const t=await this.getUserSettings();this.settings$.next(t)}catch(t){console.error("SettingsService: Failed to load settings",t)}}async getUserSettings(){return v()?{workAddress:(await chrome.storage.local.get(["homeAddress","workAddress"])||{}).workAddress||b}:(console.warn("Chrome storage not available, returning default settings"),{workAddress:b})}async saveUserSettings(t){if(!v()){console.warn("Chrome storage not available, cannot save settings");return}await chrome.storage.local.set({workAddress:t.workAddress})}async saveSettingsToStorage(t){try{await this.saveUserSettings(t),console.log("SettingsService: Saved settings",t),this.settings$.next(t)}catch(r){throw console.error("SettingsService: Failed to save settings",r),r}}}const O=T(K).getInstance();class m{static async get(e){if(!v())return null;try{const t=await chrome.storage.local.get([e]);return t[e]&&(!Array.isArray(t[e])||t[e].length>0)?t[e]:null}catch(t){return console.error(`StorageService - Error getting ${e}:`,t),null}}static async set(e,t){if(!v())throw new Error("Extension context not available");try{await chrome.storage.local.set({[e]:t})}catch(r){throw console.error(`StorageService - Error saving ${e}:`,r),r}}}const i=class i extends I{constructor(){super();l(this,"sessions$",this.createObservable("sessions",[]));this.loadSessionsFromStorage(),this.setupSettingsListener()}static _categorizeSession(t,r){const n={...t};return r&&t.location.toLowerCase().includes(r)?n.locationType=E.WORK:n.locationType=E.OTHER,n}static _categorizeSessions(t,r){const n=r==null?void 0:r.toLowerCase();return t.map(o=>this._categorizeSession(o,n))}setupSettingsListener(){O.settings$.subscribe(()=>{this.loadSessionsFromStorage()})}async getChargingSessions(){try{return await m.get(i.CHARGING_SESSIONS_KEY)||[]}catch(t){return console.error("SessionsService - Error getting sessions:",t),[]}}async loadSessionsFromStorage(){const[t,r]=await Promise.all([this.getChargingSessions(),O.getUserSettings()]),n=i._categorizeSessions(t,r==null?void 0:r.workAddress);this.sessions$.next(n)}async saveSessionsToStorage(t){try{await m.set(i.CHARGING_SESSIONS_KEY,t),this.sessions$.next(t)}catch(r){throw console.error("SessionsService - Error saving sessions:",r),r}}async getSavedSessionsCount(){return(await this.getChargingSessions()).length}async clearSessionsFromStorage(){await m.set(i.CHARGING_SESSIONS_KEY,[]),this.sessions$.next([])}};l(i,"CHARGING_SESSIONS_KEY","chargingSessions");let f=i;const ne=T(f).getInstance();var F=Object.defineProperty,M=Object.defineProperties,R=Object.getOwnPropertyDescriptors,_=Object.getOwnPropertySymbols,U=Object.prototype.hasOwnProperty,V=Object.prototype.propertyIsEnumerable,C=(s,e,t)=>e in s?F(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,G=(s,e)=>{for(var t in e||(e={}))U.call(e,t)&&C(s,t,e[t]);if(_)for(var t of _(e))V.call(e,t)&&C(s,t,e[t]);return s},L=(s,e)=>M(s,R(e)),S=(s,e,t)=>new Promise((r,n)=>{var o=a=>{try{g(t.next(a))}catch(p){n(p)}},u=a=>{try{g(t.throw(a))}catch(p){n(p)}},g=a=>a.done?r(a.value):Promise.resolve(a.value).then(o,u);g((t=t.apply(s,e)).next())}),d,c,j=typeof window<"u"&&typeof window.fetch<"u",A,z=typeof chrome<"u"&&!!((A=chrome.runtime)!=null&&A.id);y();var $={US:"https://us.aptabase.com",EU:"https://eu.aptabase.com",DEV:"http://localhost:3000",SH:""};function y(){let s=Math.floor(Date.now()/1e3).toString(),e=Math.floor(Math.random()*1e8).toString().padStart(8,"0");return s+e}function Y(s){let e=s.split("-");return e.length!==3||$[e[1]]===void 0?(console.warn(`The Aptabase App Key "${s}" is invalid. Tracking will be disabled.`),!1):!0}function W(s,e){var t;let r=s.split("-")[1];if(r==="SH"){if(!(e!=null&&e.host)){console.warn("Host parameter must be defined when using Self-Hosted App Key. Tracking will be disabled.");return}return`${e.host}/api/v0/event`}return`${(t=e==null?void 0:e.host)!=null?t:$[r]}/api/v0/event`}function B(s){return S(this,null,function*(){var e,t,r;if(!j&&!z){console.warn(`Aptabase: trackEvent requires a browser environment. Event "${s.eventName}" will be discarded.`);return}if(!s.appKey){console.warn(`Aptabase: init must be called before trackEvent. Event "${s.eventName}" will be discarded.`);return}try{let n=yield fetch(s.apiUrl,{method:"POST",headers:{"Content-Type":"application/json","App-Key":s.appKey},credentials:"omit",body:JSON.stringify({timestamp:new Date().toISOString(),sessionId:s.sessionId,eventName:s.eventName,systemProps:{locale:(e=s.locale)!=null?e:q(),isDebug:(t=s.isDebug)!=null?t:J(),appVersion:(r=s.appVersion)!=null?r:"",sdkVersion:s.sdkVersion},props:s.props})});if(n.status>=300){let o=yield n.text();console.warn(`Failed to send event "${s.eventName}": ${n.status} ${o}`)}}catch(n){console.warn(`Failed to send event "${s.eventName}"`),console.warn(n)}})}function q(){if(d)return d;if(typeof navigator<"u")return navigator.languages.length>0?d=navigator.languages[0]:d=navigator.language,d}function J(){return c!==void 0?c:typeof location>"u"?(c=!1,c):(c=location.hostname==="localhost",c)}var Q=1*60*60,X="aptabase-browser@0.1.2",k="document"in globalThis,x="",w,h;globalThis.aptabase={init:Z,trackEvent:D};function Z(s,e){return S(this,null,function*(){var t,r,n;if(k){console.error("@aptabase/browser can only be initialized in your background script.");return}if(!Y(s))return;let o=yield chrome.management.getSelf(),u=(t=e==null?void 0:e.isDebug)!=null?t:o.installType==="development",g=(r=e==null?void 0:e.appVersion)!=null?r:chrome.runtime.getManifest().version;w=(n=e==null?void 0:e.apiUrl)!=null?n:W(s,e),x=s,h=L(G({},e),{isDebug:u,appVersion:g}),chrome.runtime.onMessage.addListener((a,p,te)=>{a&&a.type==="__aptabase__trackEvent"&&D(a.eventName,a.props)})})}function D(s,e){return S(this,null,function*(){if(k)return chrome.runtime.sendMessage({type:"__aptabase__trackEvent",eventName:s,props:e});if(!w)return;let t=yield ee();return B({apiUrl:w,sessionId:t,appKey:x,isDebug:h==null?void 0:h.isDebug,appVersion:h==null?void 0:h.appVersion,sdkVersion:X,eventName:s,props:e})})}var N=y();function ee(){return S(this,null,function*(){var s;let e=Date.now();return(s=chrome==null?void 0:chrome.storage)!=null&&s.local?new Promise(t=>{chrome.storage.local.get("_ab_session_id",r=>{var n;let o=(n=r._ab_session_id)!=null?n:{id:N,lastTouched:Date.now()},u=e-o.lastTouched;Math.floor(u/1e3)>Q&&(o.id=y()),o.lastTouched=e,chrome.storage.local.set({_ab_session_id:o},()=>{t(o.id)})})}):N})}export{re as C,Z as H,E as L,I as O,D as V,O as a,T as c,ne as s,b as w};
